<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>itwinai.parser &mdash; itwinai 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            itwinai
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ðŸ’¡ Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started_with_itwinai.html">Getting started with itwinai</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸª„ itwinai Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">itwinai</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸ“š Integrated Use-cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">Integrated Use Cases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ðŸš€ Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">ML workflow tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">itwinai</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">itwinai.parser</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for itwinai.parser</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provide functionalities to manage configuration files, including parsing,</span>
<span class="sd">execution, and dynamic override of fields.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">jsonargparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span> <span class="k">as</span> <span class="n">JAPArgumentParser</span>
<span class="kn">from</span> <span class="nn">jsonargparse</span> <span class="kn">import</span> <span class="n">ActionConfigFile</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">jsonargparse._formatters</span> <span class="kn">import</span> <span class="n">DefaultHelpFormatter</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">OmegaConf</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">.components</span> <span class="kn">import</span> <span class="n">BaseComponent</span>
<span class="kn">from</span> <span class="nn">.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">load_yaml</span>


<div class="viewcode-block" id="add_replace_field">
<a class="viewcode-back" href="../../itwinai.parser.html#itwinai.parser.add_replace_field">[docs]</a>
<span class="k">def</span> <span class="nf">add_replace_field</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">key_chain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace or add (if not present) a field in a dictionary, following a</span>
<span class="sd">    path of dot-separated keys. Adding is not supported for list items.</span>
<span class="sd">    Inplace operation.</span>
<span class="sd">    Args:</span>
<span class="sd">        config (Dict): dictionary to be modified.</span>
<span class="sd">        key_chain (str): path of nested (dot-separated) keys to specify the</span>
<span class="sd">        location</span>
<span class="sd">        of the new value (e.g., &#39;foo.bar.line&#39; adds/overwrites the value</span>
<span class="sd">        located at config[&#39;foo&#39;][&#39;bar&#39;][&#39;line&#39;]).</span>
<span class="sd">        value (Any): the value to insert.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sub_config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_chain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_chain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Last key reached</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_config</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">next_elem</span> <span class="o">=</span> <span class="n">sub_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_elem</span> <span class="o">=</span> <span class="n">sub_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_elem</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">sub_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">sub_config</span> <span class="o">=</span> <span class="n">sub_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_config</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">sub_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>



<div class="viewcode-block" id="ConfigParser">
<a class="viewcode-back" href="../../itwinai.parser.html#itwinai.parser.ConfigParser">[docs]</a>
<span class="k">class</span> <span class="nc">ConfigParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a pipeline from a configuration file.</span>
<span class="sd">    It also provides functionalities for dynamic override</span>
<span class="sd">    of fields by means of nested key notation.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (Union[str, Dict]): path to YAML configuration file</span>
<span class="sd">        or dict storing a configuration.</span>
<span class="sd">        override_keys (Optional[Dict[str, Any]], optional): dict mapping</span>
<span class="sd">        nested keys to the value to override. Defaults to None.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; # pipeline.yaml file</span>
<span class="sd">    &gt;&gt;&gt; pipeline:</span>
<span class="sd">    &gt;&gt;&gt;   class_path: itwinai.pipeline.Pipeline</span>
<span class="sd">    &gt;&gt;&gt;   init_args:</span>
<span class="sd">    &gt;&gt;&gt;     steps:</span>
<span class="sd">    &gt;&gt;&gt;       - class_path: dataloader.MNISTDataModuleTorch</span>
<span class="sd">    &gt;&gt;&gt;         init_args:</span>
<span class="sd">    &gt;&gt;&gt;           save_path: .tmp/</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt;       - class_path: itwinai.torch.trainer.TorchTrainerMG</span>
<span class="sd">    &gt;&gt;&gt;         init_args:</span>
<span class="sd">    &gt;&gt;&gt;           model:</span>
<span class="sd">    &gt;&gt;&gt;             class_path: model.Net</span>
<span class="sd">    &gt;&gt;&gt;           loss:</span>
<span class="sd">    &gt;&gt;&gt;             class_path: torch.nn.NLLLoss</span>
<span class="sd">    &gt;&gt;&gt;             init_args:</span>
<span class="sd">    &gt;&gt;&gt;               reduction: mean</span>

<span class="sd">    &gt;&gt;&gt; from itwinai.parser import ConfigParser</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; parser = ConfigParser(</span>
<span class="sd">    &gt;&gt;&gt;     config=&#39;pipeline.yaml&#39;,</span>
<span class="sd">    &gt;&gt;&gt;     override_keys={</span>
<span class="sd">    &gt;&gt;&gt;         &#39;pipeline.init_args.steps.0.init_args.save_path&#39;: /save/path</span>
<span class="sd">    &gt;&gt;&gt;     }</span>
<span class="sd">    &gt;&gt;&gt; )</span>
<span class="sd">    &gt;&gt;&gt; pipeline = parser.parse_pipeline()</span>
<span class="sd">    &gt;&gt;&gt; print(pipeline)</span>
<span class="sd">    &gt;&gt;&gt; print(pipeline.steps)</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; dataloader = parser.parse_step(0)</span>
<span class="sd">    &gt;&gt;&gt; print(dataloader)</span>
<span class="sd">    &gt;&gt;&gt; print(dataloader.save_path)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
        <span class="n">override_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override_keys</span> <span class="o">=</span> <span class="n">override_keys</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_override_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omegaconf_interpolate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_dynamic_override_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key_chain</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">add_replace_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">key_chain</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_omegaconf_interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs variable interpolation with OmegaConf on internal</span>
<span class="sd">        configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_container</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">resolve</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigParser.parse_pipeline">
<a class="viewcode-back" href="../../itwinai.parser.html#itwinai.parser.ConfigParser.parse_pipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_pipeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_nested_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pipeline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges steps into pipeline and parses it.</span>

<span class="sd">        Args:</span>
<span class="sd">            pipeline_nested_key (str, optional): nested key in the</span>
<span class="sd">            configuration file identifying the pipeline object.</span>
<span class="sd">            Defaults to &quot;pipeline&quot;.</span>
<span class="sd">            verbose (bool): if True, prints the assembled pipeline</span>
<span class="sd">            to console formatted as JSON.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pipeline: instantiated pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipe_parser</span> <span class="o">=</span> <span class="n">JAPArgumentParser</span><span class="p">()</span>
        <span class="n">pipe_parser</span><span class="o">.</span><span class="n">add_subclass_arguments</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">)</span>

        <span class="n">pipe_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline_nested_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">pipe_dict</span> <span class="o">=</span> <span class="n">pipe_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># pipe_dict = self.config[pipeline_nested_key]</span>
        <span class="n">pipe_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="n">pipe_dict</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assembled pipeline:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pipe_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Parse pipeline dict once merged with steps</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">pipe_parser</span><span class="o">.</span><span class="n">parse_object</span><span class="p">(</span><span class="n">pipe_dict</span><span class="p">)</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe_parser</span><span class="o">.</span><span class="n">instantiate_classes</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span></div>


<div class="viewcode-block" id="ConfigParser.parse_step">
<a class="viewcode-back" href="../../itwinai.parser.html#itwinai.parser.ConfigParser.parse_step">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">step_idx</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">pipeline_nested_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseComponent</span><span class="p">:</span>
        <span class="n">pipeline_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline_nested_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">pipeline_dict</span> <span class="o">=</span> <span class="n">pipeline_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">step_dict_config</span> <span class="o">=</span> <span class="n">pipeline_dict</span><span class="p">[</span><span class="s1">&#39;init_args&#39;</span><span class="p">][</span><span class="s1">&#39;steps&#39;</span><span class="p">][</span><span class="n">step_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;STEP &#39;</span><span class="si">{</span><span class="n">step_idx</span><span class="si">}</span><span class="s2">&#39; CONFIG:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">step_dict_config</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Wrap config under &quot;step&quot; field and parse it</span>
        <span class="n">step_dict_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step_dict_config</span><span class="p">}</span>
        <span class="n">step_parser</span> <span class="o">=</span> <span class="n">JAPArgumentParser</span><span class="p">()</span>
        <span class="n">step_parser</span><span class="o">.</span><span class="n">add_subclass_arguments</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">)</span>
        <span class="n">parsed_namespace</span> <span class="o">=</span> <span class="n">step_parser</span><span class="o">.</span><span class="n">parse_object</span><span class="p">(</span><span class="n">step_dict_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">step_parser</span><span class="o">.</span><span class="n">instantiate_classes</span><span class="p">(</span><span class="n">parsed_namespace</span><span class="p">)[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="ArgumentParser">
<a class="viewcode-back" href="../../itwinai.parser.html#itwinai.parser.ArgumentParser">[docs]</a>
<span class="k">class</span> <span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">JAPArgumentParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">env_prefix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">DefaultHelpFormatter</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHelpFormatter</span><span class="p">,</span>
        <span class="n">exit_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--print_config&quot;</span><span class="p">,</span>
        <span class="n">parser_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span><span class="p">,</span>
        <span class="n">dump_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_config_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">default_meta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer for ArgumentParser instance.</span>

<span class="sd">        All the arguments from the initializer of `argparse.ArgumentParser</span>
<span class="sd">        &lt;https://docs.python.org/3/library/argparse.html#argparse.ArgumentParser&gt;`_</span>
<span class="sd">        are supported. Additionally it accepts:</span>

<span class="sd">        Args:</span>
<span class="sd">            env_prefix: Prefix for environment variables. ``True`` to derive</span>
<span class="sd">            from ``prog``.</span>
<span class="sd">            formatter_class: Class for printing help messages.</span>
<span class="sd">            logger: Configures the logger, see :class:`.LoggerProperty`.</span>
<span class="sd">            version: Program version which will be printed by the --version</span>
<span class="sd">            argument.</span>
<span class="sd">            print_config: Add this as argument to print config, set None to</span>
<span class="sd">            disable.</span>
<span class="sd">            parser_mode: Mode for parsing config files: ``&#39;yaml&#39;``,</span>
<span class="sd">            ``&#39;jsonnet&#39;`` or ones added via :func:`.set_loader`.</span>
<span class="sd">            dump_header: Header to include as comment when dumping a config</span>
<span class="sd">            object.</span>
<span class="sd">            default_config_files: Default config file locations, e.g.</span>
<span class="sd">            :code:`[&#39;~/.config/myapp/*.yaml&#39;]`.</span>
<span class="sd">            default_env: Set the default value on whether to parse environment</span>
<span class="sd">            variables.</span>
<span class="sd">            default_meta: Set the default value on whether to include metadata</span>
<span class="sd">            in config objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">env_prefix</span><span class="o">=</span><span class="n">env_prefix</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">formatter_class</span><span class="p">,</span>
            <span class="n">exit_on_error</span><span class="o">=</span><span class="n">exit_on_error</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">print_config</span><span class="o">=</span><span class="n">print_config</span><span class="p">,</span> <span class="n">parser_mode</span><span class="o">=</span><span class="n">parser_mode</span><span class="p">,</span>
            <span class="n">dump_header</span><span class="o">=</span><span class="n">dump_header</span><span class="p">,</span> <span class="n">default_config_files</span><span class="o">=</span><span class="n">default_config_files</span><span class="p">,</span>
            <span class="n">default_env</span><span class="o">=</span><span class="n">default_env</span><span class="p">,</span>
            <span class="n">default_meta</span><span class="o">=</span><span class="n">default_meta</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ActionConfigFile</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a configuration file in json or yaml format.&quot;</span>
        <span class="p">)</span></div>



<span class="c1"># class ConfigParser2:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Deprecated: this pipeline structure does not allow for</span>
<span class="c1">#     nested pipelines. However, it is more readable and the linking</span>
<span class="c1">#     from name to step data could be achieved with OmegaConf. This</span>
<span class="c1">#     could be reused in the future: left as example.</span>

<span class="c1">#     Parses a configuration file, merging the steps into</span>
<span class="c1">#     the pipeline and returning a pipeline object.</span>
<span class="c1">#     It also provides functionalities for dynamic override</span>
<span class="c1">#     of fields by means of nested key notation.</span>

<span class="c1">#     Example:</span>

<span class="c1">#     &gt;&gt;&gt; # pipeline.yaml</span>
<span class="c1">#     &gt;&gt;&gt; pipeline:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: itwinai.pipeline.Pipeline</span>
<span class="c1">#     &gt;&gt;&gt;   steps: [server, client]</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; server:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: mycode.ServerOptions</span>
<span class="c1">#     &gt;&gt;&gt;   init_args:</span>
<span class="c1">#     &gt;&gt;&gt;     host: localhost</span>
<span class="c1">#     &gt;&gt;&gt;     port: 80</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; client:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: mycode.ClientOptions</span>
<span class="c1">#     &gt;&gt;&gt;   init_args:</span>
<span class="c1">#     &gt;&gt;&gt;     url: http://${server.init_args.host}:${server.init_args.port}/</span>

<span class="c1">#     &gt;&gt;&gt; from itwinai.parser import ConfigParser2</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; parser = ConfigParser2(</span>
<span class="c1">#     &gt;&gt;&gt;     config=&#39;pipeline.yaml&#39;,</span>
<span class="c1">#     &gt;&gt;&gt;     override_keys={</span>
<span class="c1">#     &gt;&gt;&gt;         &#39;server.init_args.port&#39;: 777</span>
<span class="c1">#     &gt;&gt;&gt;     }</span>
<span class="c1">#     &gt;&gt;&gt; )</span>
<span class="c1">#     &gt;&gt;&gt; pipeline = parser.parse_pipeline()</span>
<span class="c1">#     &gt;&gt;&gt; print(pipeline)</span>
<span class="c1">#     &gt;&gt;&gt; print(pipeline.steps)</span>
<span class="c1">#     &gt;&gt;&gt; print(pipeline.steps[&#39;server&#39;].port)</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; server = parser.parse_step(&#39;server&#39;)</span>
<span class="c1">#     &gt;&gt;&gt; print(server)</span>
<span class="c1">#     &gt;&gt;&gt; print(server.port)</span>
<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     config: Dict</span>
<span class="c1">#     pipeline: Pipeline</span>

<span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         config: Union[str, Dict],</span>
<span class="c1">#         override_keys: Optional[Dict[str, Any]] = None</span>
<span class="c1">#     ) -&gt; None:</span>
<span class="c1">#         self.config = config</span>
<span class="c1">#         self.override_keys = override_keys</span>
<span class="c1">#         if isinstance(self.config, str):</span>
<span class="c1">#             self.config = load_yaml(self.config)</span>
<span class="c1">#         self._dynamic_override_keys()</span>
<span class="c1">#         self._omegaconf_interpolate()</span>

<span class="c1">#     def _dynamic_override_keys(self):</span>
<span class="c1">#         if self.override_keys is not None:</span>
<span class="c1">#             for key_chain, value in self.override_keys.items():</span>
<span class="c1">#                 add_replace_field(self.config, key_chain, value)</span>

<span class="c1">#     def _omegaconf_interpolate(self) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;Performs variable interpolation with OmegaConf on internal</span>
<span class="c1">#         configuration file.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         conf = OmegaConf.create(self.config)</span>
<span class="c1">#         self.config = OmegaConf.to_container(conf, resolve=True)</span>

<span class="c1">#     def parse_pipeline(</span>
<span class="c1">#         self,</span>
<span class="c1">#         pipeline_nested_key: str = &quot;pipeline&quot;,</span>
<span class="c1">#         verbose: bool = False</span>
<span class="c1">#     ) -&gt; Pipeline:</span>
<span class="c1">#         &quot;&quot;&quot;Merges steps into pipeline and parses it.</span>

<span class="c1">#         Args:</span>
<span class="c1">#             pipeline_nested_key (str, optional): nested key in the</span>
<span class="c1">#             configuration file identifying the pipeline object.</span>
<span class="c1">#             Defaults to &quot;pipeline&quot;.</span>
<span class="c1">#             verbose (bool): if True, prints the assembled pipeline</span>
<span class="c1">#             to console formatted as JSON.</span>

<span class="c1">#         Returns:</span>
<span class="c1">#             Pipeline: instantiated pipeline.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         pipe_parser = JAPArgumentParser()</span>
<span class="c1">#         pipe_parser.add_subclass_arguments(Pipeline, pipeline_nested_key)</span>
<span class="c1">#         pipe_dict = self.config[pipeline_nested_key]</span>

<span class="c1">#         # Pop steps list from pipeline dictionary</span>
<span class="c1">#         steps_list = pipe_dict[&#39;steps&#39;]</span>
<span class="c1">#         del pipe_dict[&#39;steps&#39;]</span>

<span class="c1">#         # Link steps with respective dictionaries</span>
<span class="c1">#         if not pipe_dict.get(&#39;init_args&#39;):</span>
<span class="c1">#             pipe_dict[&#39;init_args&#39;] = {}</span>
<span class="c1">#         steps_dict = pipe_dict[&#39;init_args&#39;][&#39;steps&#39;] = {}</span>
<span class="c1">#         for step_name in steps_list:</span>
<span class="c1">#             steps_dict[step_name] = self.config[step_name]</span>
<span class="c1">#         pipe_dict = {pipeline_nested_key: pipe_dict}</span>

<span class="c1">#         if verbose:</span>
<span class="c1">#             print(&quot;Assembled pipeline:&quot;)</span>
<span class="c1">#             print(json.dumps(pipe_dict, indent=4))</span>

<span class="c1">#         # Parse pipeline dict once merged with steps</span>
<span class="c1">#         conf = pipe_parser.parse_object(pipe_dict)</span>
<span class="c1">#         pipe = pipe_parser.instantiate_classes(conf)</span>
<span class="c1">#         self.pipeline = pipe[pipeline_nested_key]</span>
<span class="c1">#         return self.pipeline</span>

<span class="c1">#     def parse_step(</span>
<span class="c1">#         self,</span>
<span class="c1">#         step_name: str,</span>
<span class="c1">#         verbose: bool = False</span>
<span class="c1">#     ) -&gt; BaseComponent:</span>
<span class="c1">#         step_dict_config = self.config[step_name]</span>

<span class="c1">#         if verbose:</span>
<span class="c1">#             print(f&quot;STEP &#39;{step_name}&#39; CONFIG:&quot;)</span>
<span class="c1">#             print(json.dumps(step_dict_config, indent=4))</span>

<span class="c1">#         # Wrap config under &quot;step&quot; field and parse it</span>
<span class="c1">#         step_dict_config = {&#39;step&#39;: step_dict_config}</span>
<span class="c1">#         step_parser = JAPArgumentParser()</span>
<span class="c1">#         step_parser.add_subclass_arguments(BaseComponent, &quot;step&quot;)</span>
<span class="c1">#         parsed_namespace = step_parser.parse_object(step_dict_config)</span>
<span class="c1">#         return step_parser.instantiate_classes(parsed_namespace)[&quot;step&quot;]</span>


<span class="c1"># class ItwinaiCLI2:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Deprecated: the dynamic override does not work with nested parameters</span>
<span class="c1">#     and may be confusing.</span>

<span class="c1">#     CLI tool for executing a configuration file, with dynamic</span>
<span class="c1">#     override of fields and variable interpolation with Omegaconf.</span>

<span class="c1">#     Example:</span>

<span class="c1">#     &gt;&gt;&gt; # train.py</span>
<span class="c1">#     &gt;&gt;&gt; from itwinai.parser import ItwinaiCLI</span>
<span class="c1">#     &gt;&gt;&gt; cli = ItwinaiCLI()</span>
<span class="c1">#     &gt;&gt;&gt; cli.pipeline.execute()</span>

<span class="c1">#     &gt;&gt;&gt; # pipeline.yaml</span>
<span class="c1">#     &gt;&gt;&gt; pipeline:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: itwinai.pipeline.Pipeline</span>
<span class="c1">#     &gt;&gt;&gt;   steps: [server, client]</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; server:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: mycode.ServerOptions</span>
<span class="c1">#     &gt;&gt;&gt;   init_args:</span>
<span class="c1">#     &gt;&gt;&gt;     host: localhost</span>
<span class="c1">#     &gt;&gt;&gt;     port: 80</span>
<span class="c1">#     &gt;&gt;&gt;</span>
<span class="c1">#     &gt;&gt;&gt; client:</span>
<span class="c1">#     &gt;&gt;&gt;   class_path: mycode.ClientOptions</span>
<span class="c1">#     &gt;&gt;&gt;   init_args:</span>
<span class="c1">#     &gt;&gt;&gt;     url: http://${server.init_args.host}:${server.init_args.port}/</span>

<span class="c1">#     From command line:</span>

<span class="c1">#     &gt;&gt;&gt; python train.py --config itwinai-conf.yaml --help</span>
<span class="c1">#     &gt;&gt;&gt; python train.py --config itwinai-conf.yaml</span>
<span class="c1">#     &gt;&gt;&gt; python train.py --config itwinai-conf.yaml --server.port 8080</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     _parser: JAPArgumentParser</span>
<span class="c1">#     _config: Dict</span>
<span class="c1">#     pipeline: Pipeline</span>

<span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         pipeline_nested_key: str = &quot;pipeline&quot;,</span>
<span class="c1">#         parser_mode: str = &quot;omegaconf&quot;</span>
<span class="c1">#     ) -&gt; None:</span>
<span class="c1">#         self.pipeline_nested_key = pipeline_nested_key</span>
<span class="c1">#         self.parser_mode = parser_mode</span>
<span class="c1">#         self._init_parser()</span>
<span class="c1">#         self._parser.add_argument(f&quot;--{self.pipeline_nested_key}&quot;, type=dict)</span>
<span class="c1">#         self._add_steps_arguments()</span>
<span class="c1">#         self._config = self._parser.parse_args()</span>

<span class="c1">#         # Merge steps into pipeline and parse it</span>
<span class="c1">#         del self._config[&#39;config&#39;]</span>
<span class="c1">#         pipe_parser = ConfigParser2(config=self._config.as_dict())</span>
<span class="c1">#         self.pipeline = pipe_parser.parse_pipeline(</span>
<span class="c1">#             pipeline_nested_key=self.pipeline_nested_key</span>
<span class="c1">#         )</span>

<span class="c1">#     def _init_parser(self):</span>
<span class="c1">#         self._parser = JAPArgumentParser(parser_mode=self.parser_mode)</span>
<span class="c1">#         self._parser.add_argument(</span>
<span class="c1">#             &quot;-c&quot;, &quot;--config&quot;, action=ActionConfigFile,</span>
<span class="c1">#             required=True,</span>
<span class="c1">#             help=&quot;Path to a configuration file in json or yaml format.&quot;</span>
<span class="c1">#         )</span>

<span class="c1">#     def _add_steps_arguments(self):</span>
<span class="c1">#         &quot;&quot;&quot;Pre-parses the configuration file, dynamically adding all the</span>
<span class="c1">#         component classes under &#39;steps&#39; as arguments of the parser.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if &quot;--config&quot; not in sys.argv:</span>
<span class="c1">#             raise ValueError(</span>
<span class="c1">#                 &quot;--config parameter has to be specified with a &quot;</span>
<span class="c1">#                 &quot;valid path to a configuration file.&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#         config_path = sys.argv.index(&quot;--config&quot;) + 1</span>
<span class="c1">#         config_path = sys.argv[config_path]</span>
<span class="c1">#         config = load_yaml(config_path)</span>

<span class="c1">#         # Add steps to parser</span>
<span class="c1">#         steps = filter(</span>
<span class="c1">#             lambda itm: itm[0] != self.pipeline_nested_key,</span>
<span class="c1">#             config.items()</span>
<span class="c1">#         )</span>
<span class="c1">#         steps = {</span>
<span class="c1">#             step_name: step_data[&#39;class_path&#39;]</span>
<span class="c1">#             for step_name, step_data in steps</span>
<span class="c1">#         }</span>

<span class="c1">#         for st_nested_key, step_class_str in steps.items():</span>
<span class="c1">#             step_class = dynamically_import_class(step_class_str)</span>
<span class="c1">#             self._add_step_arguments(</span>
<span class="c1">#                 step_class=step_class, nested_key=st_nested_key)</span>

<span class="c1">#     def _add_step_arguments(self, step_class, nested_key):</span>
<span class="c1">#         self._parser.add_subclass_arguments(</span>
<span class="c1">#             baseclass=step_class, nested_key=nested_key)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Matteo Bunino, Alexander Zoechbauer, Kalliopi Tsolaki on behalf of CERN.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>